# üêõ Fix: ERR_REQUIRE_ESM pdf-parse/pdfjs-dist

## ‚ùå Probl√®me

```bash
Error [ERR_REQUIRE_ESM]: require() of ES Module /app/node_modules/.pnpm/pdfjs-dist@5.4.149/node_modules/pdfjs-dist/legacy/build/pdf.mjs not supported.
```

## üîç Cause

- `pdf-parse@2.1.6` utilise `require()` pour importer `pdfjs-dist`
- `pdfjs-dist@5.x` est devenu un module ES pur (ESM)
- Conflit entre CommonJS (`require`) et ES modules (`import`)

## ‚úÖ Solution appliqu√©e

### 1. **R√©solution de version forc√©e**

Dans `package.json` (racine) :
```json
{
  "pnpm": {
    "overrides": {
      "pdfjs-dist": "4.7.76"
    }
  }
}
```

### 2. **Script de correction**

Ex√©cutez `./scripts/fix-pdf-parse.sh` pour :
- Nettoyer les `node_modules`
- Supprimer `pnpm-lock.yaml`
- R√©installer avec la version forc√©e

### 3. **Dockerfile mis √† jour**

Le Dockerfile API utilise maintenant la r√©solution forc√©e.

## üöÄ Instructions de correction

### En d√©veloppement local :
```bash
# Ex√©cuter le script de correction
./scripts/fix-pdf-parse.sh

# Ou manuellement :
rm -rf node_modules pnpm-lock.yaml
pnpm install
pnpm build
```

### En production (Docker) :
```bash
# Rebuilder l'image Docker
docker-compose build api workers

# Ou avec cache nettoy√© :
docker-compose build --no-cache api workers
```

## üìã V√©rification

Apr√®s correction, v√©rifiez que :
```bash
# La version de pdfjs-dist est correcte
pnpm list pdfjs-dist
# Devrait afficher: pdfjs-dist@4.7.76

# L'application d√©marre sans erreur
pnpm dev
# ou
docker-compose up
```

## üîß Alternatives possibles

Si le probl√®me persiste :

### Option 1: Remplacer pdf-parse
```bash
pnpm remove pdf-parse
pnpm add pdf2pic  # Alternative qui supporte ESM
```

### Option 2: Utiliser une version sp√©cifique
```json
{
  "dependencies": {
    "pdf-parse": "1.1.1",
    "pdfjs-dist": "4.7.76"
  }
}
```

### Option 3: Import dynamique
Modifier le code pour utiliser `import()` au lieu de `require()`.

## üìù Notes

- `pdfjs-dist@4.7.76` est la derni√®re version compatible CommonJS
- `pdfjs-dist@5.x+` n√©cessite des imports ES modules
- La r√©solution forc√©e garantit la compatibilit√© avec `pdf-parse`

Cette solution maintient la fonctionnalit√© PDF tout en r√©solvant le conflit ESM/CommonJS ! üéâ