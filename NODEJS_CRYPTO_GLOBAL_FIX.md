# Node.js Crypto Global Fix - ReferenceError: crypto is not defined

## üö® **Erreur rencontr√©e**

```
ReferenceError: crypto is not defined
    at SchedulerOrchestrator.addCron (/app/node_modules/.pnpm/@nestjs+schedule@6.0.1_.../dist/scheduler.orchestrator.js:90:38)
    const name = options.name || crypto.randomUUID();
                                 ^
```

## üîç **Diagnostic**

Cette erreur se produit avec `@nestjs/schedule` parce que :
1. **Node.js 18.x** n'expose pas toujours l'objet global `crypto`
2. `@nestjs/schedule` utilise `crypto.randomUUID()` sans importer le module
3. L'API crypto moderne n√©cessite une configuration sp√©cifique

## ‚úÖ **Solutions impl√©ment√©es**

### **Solution 1 : Upgrade Node.js 18 ‚Üí 20**

**Changements dans les Dockerfiles** :
```dockerfile
# AVANT
FROM node:18-bookworm-slim AS base

# APR√àS
FROM node:20-bookworm-slim AS base
```

**Avantages Node.js 20** :
- ‚úÖ Objet `crypto` global disponible par d√©faut
- ‚úÖ Meilleure compatibilit√© avec les modules ES
- ‚úÖ Performance am√©lior√©e
- ‚úÖ APIs crypto modernes stabilis√©es

### **Solution 2 : Polyfill crypto global**

**Nouveau fichier** : `apps/api/src/crypto-polyfill.ts`
```typescript
import { webcrypto } from 'node:crypto';

// Make crypto available globally if not already present
if (typeof globalThis.crypto === 'undefined') {
  (globalThis as any).crypto = webcrypto;
}

// For older Node.js versions
if (typeof global.crypto === 'undefined') {
  (global as any).crypto = webcrypto;
}
```

**Import dans** `main.ts` :
```typescript
// Crypto polyfill must be imported before any other modules
import './crypto-polyfill';

import { NestFactory } from '@nestjs/core';
// ... other imports
```

### **Solution 3 : Variables d'environnement Node.js**

**Ajout dans les Dockerfiles** :
```dockerfile
ENV NODE_ENV=production

# Node.js crypto compatibility flags
ENV NODE_OPTIONS="--enable-source-maps"
ENV UV_THREADPOOL_SIZE=4
```

## üîß **Strat√©gie de d√©fense en profondeur**

| M√©thode | Port√©e | Efficacit√© | Co√ªt |
|---------|--------|------------|------|
| **Node.js 20** | Globale | ‚úÖ Tr√®s √©lev√©e | Minimal |
| **Polyfill crypto** | Application | ‚úÖ √âlev√©e | Tr√®s faible |
| **Variables ENV** | Runtime | ‚úÖ Moyenne | Aucun |

**Combinaison recommand√©e** : Les 3 solutions ensemble pour une robustesse maximale.

## üìä **Impact des changements**

### **Compatibilit√© Node.js**
| Version | crypto global | @nestjs/schedule | Recommandation |
|---------|---------------|------------------|----------------|
| Node.js 16 | ‚ùå Non | ‚ùå Probl√©matique | Upgrade |
| Node.js 18 | ‚ö†Ô∏è Partiel | ‚ö†Ô∏è Avec polyfill | Upgrade |
| Node.js 20 | ‚úÖ Oui | ‚úÖ Fonctionne | ‚úÖ Optimal |

### **Modules affect√©s**
- ‚úÖ `@nestjs/schedule` : Cron jobs, intervals
- ‚úÖ `@nestjs/jwt` : Token generation
- ‚úÖ `bcrypt` : Password hashing
- ‚úÖ `uuid` : ID generation

## üöÄ **Validation**

### **Test local**
```bash
# Build avec les corrections
pnpm --filter=@whalli/api build

# D√©marrage en mode d√©veloppement
pnpm --filter=@whalli/api dev

# V√©rifier les cron jobs dans les logs
# Rechercher: "Cron job initialized" ou similar
```

### **Test Docker**
```bash
# Build avec Node.js 20
docker build -f apps/api/Dockerfile.dokploy . -t whalli-api-crypto-fix

# Test du d√©marrage
docker run --rm --name test-crypto \
  -e DATABASE_URL="postgresql://test" \
  whalli-api-crypto-fix

# V√©rifier les logs - pas d'erreur "crypto is not defined"
```

### **Test production**
```bash
# Apr√®s d√©ploiement Dokploy
docker logs <container-id> | grep -E "(crypto|schedule|cron)"

# Logs attendus :
# ‚úÖ "Cron jobs initialized"
# ‚úÖ "Scheduler module loaded"
# ‚ùå PAS "crypto is not defined"
```

## üõ°Ô∏è **Pr√©vention future**

### **package.json - engines**
Mise √† jour des versions support√©es :
```json
{
  "engines": {
    "node": ">=20.0.0",
    "pnpm": ">=8.0.0"
  }
}
```

### **CI/CD - Matrix testing**
```yaml
# .github/workflows/ci.yml
strategy:
  matrix:
    node-version: [20, 22]  # Tester les versions LTS
```

### **Development - .nvmrc**
```bash
# .nvmrc
20
```

## üìã **Checklist de r√©solution**

- [x] Dockerfile migr√© vers Node.js 20
- [x] Polyfill crypto global cr√©√©
- [x] Import polyfill dans main.ts
- [x] Variables d'environnement Node.js ajout√©es
- [x] Build local r√©ussi
- [ ] Test Docker en local
- [ ] D√©ploiement production
- [ ] Validation cron jobs fonctionnels

## üéØ **R√©sultat attendu**

L'application devrait d√©marrer sans erreur `crypto is not defined` avec :

1. **Cron jobs** : Fonctionnels (@nestjs/schedule)
2. **JWT tokens** : G√©n√©ration correcte
3. **UUID generation** : Disponible globalement
4. **Notifications system** : T√¢ches programm√©es actives

**Priorit√©** : Node.js 20 + Polyfill = Compatibilit√© garantie üõ°Ô∏è

## üîÑ **Rollback plan**

Si probl√®mes avec Node.js 20 :
```dockerfile
# Retour temporaire √† Node.js 18 avec polyfill
FROM node:18-bookworm-slim AS base
# Le polyfill crypto reste actif
```

**Monitoring** : Surveiller les performances et la stabilit√© pendant 48h apr√®s le d√©ploiement.