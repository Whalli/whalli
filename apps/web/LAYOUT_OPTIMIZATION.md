# Layout Optimization - Consolidation du Syst√®me de Layout

## üìã Vue d'Ensemble

Optimisation architecturale du syst√®me de layout pour √©viter les imports dupliqu√©s dans chaque page. Utilisation du syst√®me de **Route Groups** de Next.js 14 pour centraliser le rendu des layouts dans un composant parent unique.

## üéØ Probl√®me R√©solu

### Avant (Architecture Non Optimale)
Chaque page importait et wrappait son contenu manuellement :

```tsx
// apps/web/src/app/chat/page.tsx
import { DualSidebarLayout } from '@/components/layout/dual-sidebar-layout';
import { ChatSecondarySidebar } from '@/components/layout/chat-secondary-sidebar';

export default function ChatPage() {
  const user = {...};
  const mockChats = [...];
  
  return (
    <DualSidebarLayout user={user} secondarySidebar={<ChatSecondarySidebar chats={mockChats} />}>
      <ChatUI />
    </DualSidebarLayout>
  );
}
```

**Probl√®mes** :
- ‚ùå Code dupliqu√© dans chaque page (import, wrapper, props)
- ‚ùå Configuration des layouts r√©p√©t√©e partout
- ‚ùå Mock data dupliqu√© (user, stats, chats)
- ‚ùå Logique de s√©lection de layout dispers√©e
- ‚ùå Maintenance difficile (changement = modifier toutes les pages)

### Apr√®s (Architecture Optimis√©e)
Un seul layout parent qui route automatiquement :

```tsx
// apps/web/src/app/(app)/layout.tsx
export default function AppLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  
  // Logique centralis√©e de s√©lection de layout
  if (pathname?.startsWith('/chat')) {
    return <DualSidebarLayout secondarySidebar={<ChatSecondarySidebar />}>
      {children}
    </DualSidebarLayout>;
  }
  
  return <MainLayout>{children}</MainLayout>;
}

// apps/web/src/app/(app)/chat/page.tsx
export default function ChatPage() {
  return <ChatUI />; // Simple et propre !
}
```

**Avantages** :
- ‚úÖ Un seul fichier g√®re tous les layouts
- ‚úÖ Pages ultra-simplifi√©es (juste le contenu)
- ‚úÖ Mock data centralis√©
- ‚úÖ Logique de routing claire et maintainable
- ‚úÖ Changement de layout = un seul fichier √† modifier

## üèóÔ∏è Architecture

### Structure de Fichiers

```
apps/web/src/app/
‚îú‚îÄ‚îÄ layout.tsx                          # Root layout (inchang√©)
‚îú‚îÄ‚îÄ (app)/                              # Route group pour l'application principale
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                      # ‚ú® NOUVEAU : Layout parent intelligent
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                        # Home (simplifi√©)
‚îÇ   ‚îú‚îÄ‚îÄ chat/page.tsx                   # Chat (simplifi√©)
‚îÇ   ‚îú‚îÄ‚îÄ tasks/page.tsx                  # Tasks (simplifi√©)
‚îÇ   ‚îú‚îÄ‚îÄ projects/page.tsx               # Projects (simplifi√©)
‚îÇ   ‚îú‚îÄ‚îÄ profile/page.tsx                # Profile (simplifi√©)
‚îÇ   ‚îî‚îÄ‚îÄ settings/page.tsx               # Settings (simplifi√©)
‚îú‚îÄ‚îÄ login/page.tsx                      # Hors du route group (pas de layout)
‚îî‚îÄ‚îÄ signup/page.tsx                     # Hors du route group (pas de layout)
```

### Logique de Routing du Layout

Le fichier `(app)/layout.tsx` utilise `usePathname()` pour d√©terminer le layout appropri√© :

```tsx
const pathname = usePathname();

// Routes avec DualSidebarLayout
const dualSidebarRoutes = ['/chat', '/tasks', '/projects'];
const isDualSidebarRoute = dualSidebarRoutes.some(route => pathname?.startsWith(route));

// Routes sans layout (authentification, API)
const noLayoutRoutes = ['/login', '/signup', '/api'];
const shouldSkipLayout = noLayoutRoutes.some(route => pathname?.startsWith(route));

// S√©lection automatique
if (shouldSkipLayout) return <>{children}</>;
if (isDualSidebarRoute) return <DualSidebarLayout {...props}>{children}</DualSidebarLayout>;
return <MainLayout user={user}>{children}</MainLayout>;
```

## üîÑ Changements par Page

### 1. Chat Page (`(app)/chat/page.tsx`)

**Avant** (57 lignes) :
```tsx
"use client";

import { DualSidebarLayout } from '@/components/layout/dual-sidebar-layout';
import { ChatSecondarySidebar } from '@/components/layout/chat-secondary-sidebar';
import { ChatUI } from '@/components/chat/chat-ui';

const mockChats = [/* 20+ lignes de donn√©es */];

export default function ChatPage() {
  const user = {
    name: 'Demo User',
    email: 'demo@whalli.com',
  };

  return (
    <DualSidebarLayout
      user={user}
      secondarySidebar={<ChatSecondarySidebar chats={mockChats} />}
    >
      <div className="h-[calc(100vh-6rem)]">
        <ChatUI userId={userId} apiUrl="http://localhost:3001" />
      </div>
    </DualSidebarLayout>
  );
}
```

**Apr√®s** (11 lignes) :
```tsx
"use client";

import { ChatUI } from '@/components/chat/chat-ui';

export default function ChatPage() {
  const userId = 'demo-user-id';
  
  return (
    <div className="h-[calc(100vh-6rem)]">
      <ChatUI userId={userId} apiUrl="http://localhost:3001" />
    </div>
  );
}
```

**R√©duction** : 46 lignes (-80%) üéâ

### 2. Tasks Page (`(app)/tasks/page.tsx`)

**Avant** :
- Importait `DualSidebarLayout` et `TasksSecondarySidebar`
- Calculait `taskStats` pour la sidebar
- Cr√©ait un objet `user`
- Wrappait tout dans `<DualSidebarLayout>`

**Apr√®s** :
```tsx
export default function TasksPage() {
  // ... logique de gestion des t√¢ches (inchang√©e)
  
  return (
    <div className="space-y-6">
      {/* UI des t√¢ches */}
    </div>
  );
}
```

**Supprim√©** :
- Imports de layout (2 lignes)
- Objet user (4 lignes)
- Calcul taskStats (8 lignes)
- Wrapper DualSidebarLayout (2 lignes)

### 3. Projects Page (`(app)/projects/page.tsx`)

**Avant** :
- Importait `DualSidebarLayout` et `ProjectsSecondarySidebar`
- Calculait `projectStats` pour la sidebar
- Pr√©parait `sidebarProjects` array
- Cr√©ait un objet `user`
- Wrappait tout dans `<DualSidebarLayout>`

**Apr√®s** :
```tsx
export default function ProjectsPage() {
  const [searchQuery, setSearchQuery] = useState('');
  // ... logique de gestion des projets (inchang√©e)
  
  return (
    <div className="space-y-6">
      {/* UI des projets */}
    </div>
  );
}
```

**Supprim√©** :
- Imports de layout (2 lignes)
- Objet user (4 lignes)
- Calculs stats (10+ lignes)
- Wrapper DualSidebarLayout (2 lignes)

### 4. Home Page (`(app)/page.tsx`)

**Avant** :
```tsx
import { MainLayout } from '@/components/layout/main-layout';

export default function HomePage() {
  const user = {
    name: 'Demo User',
    email: 'demo@whalli.com',
  };

  return (
    <MainLayout user={user}>
      <div className="space-y-12">
        {/* Contenu home */}
      </div>
    </MainLayout>
  );
}
```

**Apr√®s** :
```tsx
export default function HomePage() {
  return (
    <div className="space-y-12">
      {/* Contenu home (inchang√©) */}
    </div>
  );
}
```

**Supprim√©** :
- Import MainLayout (1 ligne)
- Objet user (4 lignes)
- Wrapper MainLayout (2 lignes)

### 5. Profile Page (`(app)/profile/page.tsx`)

**Avant** :
```tsx
import { MainLayout } from '@/components/layout/main-layout';

export default function ProfilePage() {
  // ... state formData
  
  return (
    <MainLayout user={{ name: formData.name, email: formData.email }}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Formulaire profile */}
      </div>
    </MainLayout>
  );
}
```

**Apr√®s** :
```tsx
export default function ProfilePage() {
  // ... state formData (inchang√©)
  
  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Formulaire profile (inchang√©) */}
    </div>
  );
}
```

**Supprim√©** :
- Import MainLayout (1 ligne)
- Wrapper MainLayout avec prop user (2 lignes)

### 6. Settings Page (`(app)/settings/page.tsx`)

**Avant** :
```tsx
import { MainLayout } from '@/components/layout/main-layout';

export default function SettingsPage() {
  // ... state settings
  
  const user = {
    name: 'Demo User',
    email: 'demo@whalli.com',
  };

  return (
    <MainLayout user={user}>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Param√®tres */}
      </div>
    </MainLayout>
  );
}
```

**Apr√®s** :
```tsx
export default function SettingsPage() {
  // ... state settings (inchang√©)
  
  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Param√®tres (inchang√©s) */}
    </div>
  );
}
```

**Supprim√©** :
- Import MainLayout (1 ligne)
- Objet user (4 lignes)
- Wrapper MainLayout (2 lignes)

## üì¶ Layout Parent (`(app)/layout.tsx`)

### Code Complet

```tsx
"use client";

import { usePathname } from 'next/navigation';
import { MainLayout } from '@/components/layout/main-layout';
import { DualSidebarLayout } from '@/components/layout/dual-sidebar-layout';
import { ChatSecondarySidebar } from '@/components/layout/chat-secondary-sidebar';
import { TasksSecondarySidebar } from '@/components/layout/tasks-secondary-sidebar';
import { ProjectsSecondarySidebar } from '@/components/layout/projects-secondary-sidebar';

// Mock data centralis√© (√† remplacer par des appels API)
const mockChats = [
  {
    id: '1',
    title: 'Project Planning',
    preview: 'Let\'s discuss the roadmap...',
    timestamp: '2 hours ago',
    model: 'gpt-4',
  },
  // ... autres chats
];

const mockTaskStats = {
  total: 42,
  completed: 28,
  pending: 10,
  inProgress: 4,
};

const mockProjectStats = {
  total: 8,
  active: 5,
  completed: 3,
};

const mockProjects = [
  {
    id: '1',
    name: 'Whalli Core',
    color: '#040069',
    tasksCount: 12,
    completedTasks: 8,
  },
  // ... autres projets
];

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();

  // Logique de s√©lection du layout
  const dualSidebarRoutes = ['/chat', '/tasks', '/projects'];
  const isDualSidebarRoute = dualSidebarRoutes.some(route => pathname?.startsWith(route));

  // Fonction pour obtenir la sidebar secondaire appropri√©e
  const getSecondarySidebar = () => {
    if (pathname?.startsWith('/chat')) {
      return <ChatSecondarySidebar chats={mockChats} />;
    }
    if (pathname?.startsWith('/tasks')) {
      return <TasksSecondarySidebar stats={mockTaskStats} />;
    }
    if (pathname?.startsWith('/projects')) {
      return <ProjectsSecondarySidebar stats={mockProjectStats} projects={mockProjects} />;
    }
    return null;
  };

  // Routes sans layout (authentification, API, etc.)
  const noLayoutRoutes = ['/login', '/signup', '/api'];
  const shouldSkipLayout = noLayoutRoutes.some(route => pathname?.startsWith(route));

  // User mock (√† remplacer par Better Auth)
  const user = {
    name: 'Demo User',
    email: 'demo@whalli.com',
  };

  // Rendu conditionnel du layout
  if (shouldSkipLayout) {
    return <>{children}</>;
  }

  if (isDualSidebarRoute) {
    return (
      <DualSidebarLayout
        user={user}
        secondarySidebar={getSecondarySidebar()}
      >
        {children}
      </DualSidebarLayout>
    );
  }

  return <MainLayout user={user}>{children}</MainLayout>;
}
```

### Fonctionnalit√©s

1. **Route Detection** : Utilise `usePathname()` pour identifier la route actuelle
2. **Layout Selector** : Choisit automatiquement entre `DualSidebarLayout` et `MainLayout`
3. **Secondary Sidebar Router** : S√©lectionne la sidebar secondaire appropri√©e (Chat, Tasks, Projects)
4. **No Layout Routes** : Permet de d√©sactiver le layout pour certaines routes (login, signup, API)
5. **Mock Data Centralis√©** : Toutes les donn√©es de test sont dans un seul fichier

## üé® Layouts Disponibles

### 1. MainLayout
**Utilis√© pour** : Pages simples (Home, Profile, Settings)

**Caract√©ristiques** :
- Sidebar principale de navigation (80px, icon-based)
- Pas de sidebar secondaire
- Layout responsive avec toggle mobile

**Routes** :
- `/` (Home)
- `/profile`
- `/settings`

### 2. DualSidebarLayout
**Utilis√© pour** : Pages avec sidebar contextuelle (Chat, Tasks, Projects)

**Caract√©ristiques** :
- Sidebar principale de navigation (80px, icon-based)
- Sidebar secondaire contextuelle (256px, page-specific)
- Responsive avec toggle synchronis√© sur mobile

**Routes** :
- `/chat` ‚Üí ChatSecondarySidebar
- `/tasks` ‚Üí TasksSecondarySidebar
- `/projects` ‚Üí ProjectsSecondarySidebar

### 3. No Layout
**Utilis√© pour** : Pages sans navigation (Auth, API)

**Caract√©ristiques** :
- Aucun layout wrapper
- Contenu brut (raw children)
- Page plein √©cran

**Routes** :
- `/login`
- `/signup`
- `/api/*`

## üöÄ Avantages de l'Architecture

### 1. Maintenabilit√©
- ‚úÖ Un seul point de changement pour les layouts
- ‚úÖ Logique de routing centralis√©e
- ‚úÖ Mock data centralis√© (facile √† remplacer par API)

### 2. Performance
- ‚úÖ R√©duction du code dupliqu√© (-80% sur certaines pages)
- ‚úÖ Bundle size optimis√© (un seul import des layouts)
- ‚úÖ Re-renders optimis√©s (layout persist entre pages)

### 3. D√©veloppement
- ‚úÖ Pages ultra-simples (juste le contenu)
- ‚úÖ Nouvelle page = juste le composant, pas de setup layout
- ‚úÖ Tests plus faciles (composants isol√©s)

### 4. √âvolutivit√©
- ‚úÖ Ajouter un nouveau layout = modifier un seul fichier
- ‚úÖ Changer de layout pour une route = une ligne
- ‚úÖ Int√©gration Better Auth facilit√©e (un seul endroit)

## üîß Int√©gration Future : Better Auth

Actuellement, l'objet `user` est mock√© dans le layout :

```tsx
const user = {
  name: 'Demo User',
  email: 'demo@whalli.com',
};
```

### Plan d'Int√©gration

1. **Remplacer le mock par Better Auth** :
```tsx
import { useSession } from '@/lib/auth-client';

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const { data: session } = useSession();
  const user = session?.user;

  // ... rest du code
}
```

2. **Prot√©ger les routes** :
```tsx
if (!user && !shouldSkipLayout) {
  redirect('/login');
}
```

3. **Passer l'utilisateur r√©el** :
```tsx
return <MainLayout user={user}>{children}</MainLayout>;
```

## üìä Statistiques de R√©duction de Code

| Page | Avant (lignes) | Apr√®s (lignes) | R√©duction |
|------|----------------|----------------|-----------|
| Chat | 57 | 11 | -46 (-80%) |
| Tasks | ~80 | ~70 | -10 (-12%) |
| Projects | ~85 | ~75 | -10 (-12%) |
| Home | ~160 | ~153 | -7 (-4%) |
| Profile | ~210 | ~203 | -7 (-3%) |
| Settings | ~230 | ~223 | -7 (-3%) |
| **Total** | **~822** | **~735** | **-87 (-11%)** |

**Note** : La plus grande victoire n'est pas seulement les lignes √©conomis√©es, mais la **simplification conceptuelle** et la **maintenabilit√©** du code.

## üéØ Next Steps

### 1. Int√©gration Better Auth
- [ ] Installer et configurer Better Auth
- [ ] Remplacer `const user = {...}` par `useSession()`
- [ ] Ajouter protection des routes
- [ ] G√©rer les √©tats de chargement/erreur

### 2. API Integration
- [ ] Remplacer `mockChats` par appel API `/api/messages`
- [ ] Remplacer `mockTaskStats` par appel API `/api/tasks/stats`
- [ ] Remplacer `mockProjectStats` par appel API `/api/projects/stats`
- [ ] Remplacer `mockProjects` par appel API `/api/projects`

### 3. Optimisations
- [ ] Impl√©menter SWR/React Query pour le caching
- [ ] Ajouter loading states pendant fetch API
- [ ] G√©rer les erreurs de fetch gracefully
- [ ] Ajouter refresh automatique des stats

### 4. Tests
- [ ] Tests unitaires pour le layout routing
- [ ] Tests d'int√©gration avec Better Auth
- [ ] Tests E2E de navigation entre pages
- [ ] Tests responsive mobile/desktop

## üìö Documentation Associ√©e

- **UI_REFACTOR.md** : Documentation compl√®te du syst√®me UI
- **DUAL_SIDEBAR_SYSTEM.md** : Guide du syst√®me dual sidebar
- **RESPONSIVE_DESIGN.md** : Documentation responsive mobile/desktop
- **EXECUTIVE_SUMMARY.md** : Vue d'ensemble ex√©cutive (fran√ßais)

## üéâ Conclusion

Cette optimisation transforme l'architecture d'un syst√®me **page-centric** (chaque page g√®re son layout) en un syst√®me **layout-centric** (le layout g√®re les pages). C'est une approche plus √©l√©gante, maintenable et align√©e avec les best practices de Next.js 14.

**Principe cl√©** : *"Don't repeat yourself (DRY)"* - Un seul endroit pour g√©rer tous les layouts ! üöÄ
