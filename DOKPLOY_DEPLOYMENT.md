# D√©ploiement Whalli sur Dokploy

Guide complet pour d√©ployer Whalli sur un VPS utilisant Dokploy.

## üìã Pr√©requis

### 1. VPS et Dokploy
- VPS avec Docker install√©
- Dokploy install√© sur le VPS
- Nom de domaine configur√© avec DNS

### 2. Services externes
- **Base de donn√©es PostgreSQL** (Neon, Railway, ou auto-h√©berg√©e)
- **Comptes API** : OpenAI, Anthropic, xAI, Stripe
- **OAuth Apps** : GitHub, Google

## üöÄ Installation rapide

### 1. Pr√©parer la configuration

```bash
# Copier le fichier d'environnement
cp .env.dokploy.example .env.dokploy

# √âditer la configuration
nano .env.dokploy
```

### 2. Configurer les variables d'environnement

√âditez `.env.dokploy` avec vos valeurs :

```bash
# Domaine principal
DOMAIN=votre-domaine.com

# Base de donn√©es (Neon PostgreSQL recommand√©)
DATABASE_URL=postgresql://user:password@ep-xxx.neon.tech/db?sslmode=require

# G√©n√©rer des secrets s√©curis√©s
./deploy-dokploy.sh secrets
```

### 3. D√©ployer

```bash
# D√©ploiement complet
./deploy-dokploy.sh full
```

## üîß Configuration d√©taill√©e

### Structure des services

```
whalli/
‚îú‚îÄ‚îÄ api/           # NestJS API (Port 3001)
‚îú‚îÄ‚îÄ web/           # Next.js Web App (Port 3000)
‚îú‚îÄ‚îÄ admin/         # Next.js Admin (Port 3002)
‚îú‚îÄ‚îÄ workers/       # Background Jobs
‚îú‚îÄ‚îÄ redis/         # Cache et files d'attente
‚îî‚îÄ‚îÄ minio/         # Stockage S3-compatible
```

### Domaines configur√©s

- **Web App** : `https://votre-domaine.com`
- **API** : `https://api.votre-domaine.com`
- **Admin** : `https://admin.votre-domaine.com`
- **Storage** : `https://storage.votre-domaine.com`
- **MinIO UI** : `https://minio.votre-domaine.com`

### Variables d'environnement critiques

```bash
# Authentification
JWT_SECRET=...                    # G√©n√©r√© avec openssl rand -base64 32
BETTER_AUTH_SECRET=...           # G√©n√©r√© avec openssl rand -base64 32

# Base de donn√©es
DATABASE_URL=postgresql://...    # Neon, Railway, etc.

# Redis
REDIS_PASSWORD=...               # Mot de passe s√©curis√©

# MinIO
MINIO_ROOT_PASSWORD=...          # Mot de passe administrateur

# APIs externes
OPENAI_API_KEY=sk-proj-...
ANTHROPIC_API_KEY=sk-ant-...
XAI_API_KEY=xai-...
STRIPE_SECRET_KEY=sk_test_...
```

## üì¶ Commandes de d√©ploiement

### V√©rifications pr√©alables

```bash
# V√©rifier tous les pr√©requis
./deploy-dokploy.sh check

# Valider la configuration
./deploy-dokploy.sh validate

# G√©n√©rer des secrets
./deploy-dokploy.sh secrets
```

### D√©ploiement

```bash
# D√©ploiement complet (recommand√©)
./deploy-dokploy.sh full

# Ou √©tape par √©tape
./deploy-dokploy.sh migrate     # Migrations base de donn√©es
./deploy-dokploy.sh deploy      # D√©ploiement
./deploy-dokploy.sh health      # V√©rification sant√©
```

### Gestion des services

```bash
# Consulter les logs
./deploy-dokploy.sh logs api
./deploy-dokploy.sh logs web
./deploy-dokploy.sh logs workers

# Scaler les services
./deploy-dokploy.sh scale workers 3
./deploy-dokploy.sh scale api 2

# Rollback en cas de probl√®me
./deploy-dokploy.sh rollback
```

## üîç Monitoring et maintenance

### Health checks

Les services incluent des health checks automatiques :

- **API** : `GET /api/health`
- **Web/Admin** : `GET /`
- **Intervalles** : 30s avec retry

### Logs centralis√©s

```bash
# Logs en temps r√©el
./deploy-dokploy.sh logs api --follow

# Logs sp√©cifiques
dokploy logs whalli-web --since=1h
```

### M√©triques

- **Prometheus** : M√©triques API disponibles sur `/api/metrics`
- **Ressources** : Monitoring via interface Dokploy

## üóÉÔ∏è Base de donn√©es

### Neon PostgreSQL (recommand√©)

1. Cr√©er un projet sur [neon.tech](https://neon.tech)
2. R√©cup√©rer la connection string
3. Configurer `DATABASE_URL` dans `.env.dokploy`

```bash
DATABASE_URL=postgresql://user:pass@ep-xxx.neon.tech/db?sslmode=require
```

### Migrations

```bash
# Appliquer les migrations
./deploy-dokploy.sh migrate

# Ou manuellement
cd apps/api
pnpm prisma migrate deploy
```

## üîê S√©curit√©

### Secrets √† configurer

1. **G√©n√©ration automatique** :
   ```bash
   ./deploy-dokploy.sh secrets
   ```

2. **OAuth Apps** :
   - GitHub : [Developer Settings](https://github.com/settings/developers)
   - Google : [Google Cloud Console](https://console.cloud.google.com)

3. **Stripe** :
   - Cl√©s API : [Stripe Dashboard](https://dashboard.stripe.com/apikeys)
   - Webhooks : Configurer endpoint `https://api.votre-domaine.com/api/billing/webhooks/stripe`

### Certificats SSL

Dokploy g√®re automatiquement les certificats SSL via Let's Encrypt.

## üê≥ Architecture Docker

### Images optimis√©es

- **Multi-stage builds** pour r√©duire la taille
- **Non-root users** pour la s√©curit√©
- **Health checks** int√©gr√©s
- **Cache pnpm** pour builds rapides

### Ressources par d√©faut

```yaml
api:      512Mi RAM, 0.5 CPU
web:      256Mi RAM, 0.25 CPU
admin:    256Mi RAM, 0.25 CPU
workers:  256Mi RAM, 0.25 CPU
redis:    128Mi RAM, 0.1 CPU
minio:    256Mi RAM, 0.25 CPU
```

## üö® R√©solution de probl√®mes

### Probl√®mes courants

1. **API ne d√©marre pas**
   ```bash
   # V√©rifier les logs
   ./deploy-dokploy.sh logs api
   
   # V√©rifier la connexion DB
   dokploy exec whalli-api -- npx prisma db pull
   ```

2. **Build failed**
   ```bash
   # Nettoyer le cache Docker
   docker system prune -a
   
   # Rebuilder localement
   ./deploy-dokploy.sh build
   ```

3. **Services inaccessibles**
   ```bash
   # V√©rifier le DNS
   nslookup api.votre-domaine.com
   
   # V√©rifier les certificats SSL
   curl -I https://api.votre-domaine.com
   ```

### Logs de debug

```bash
# Activer le mode debug
export DEBUG=true

# Logs d√©taill√©s
dokploy logs whalli-api --since=1h --follow
```

## üìö Ressources

- [Documentation Dokploy](https://dokploy.com/docs)
- [Neon PostgreSQL](https://neon.tech/docs)
- [Configuration Prisma](https://www.prisma.io/docs)
- [Next.js Standalone](https://nextjs.org/docs/pages/api-reference/next-config-js/output)

## üîÑ Mise √† jour

```bash
# Pull latest changes
git pull origin main

# Red√©ployer
./deploy-dokploy.sh deploy

# V√©rifier
./deploy-dokploy.sh health
```