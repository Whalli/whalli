# Migration Guide: Alpine ‚Üí Debian pour Dokploy

## üéØ **Objectif**

Migrer de `node:18-alpine` vers `node:18-bookworm-slim` pour r√©soudre d√©finitivement les probl√®mes Prisma et am√©liorer la stabilit√© en production.

## üìã **Plan de migration**

### **Phase 1 : Validation locale (Recommand√©e)**

```bash
# 1. Tester les builds en parall√®le
./scripts/compare-docker-os.sh

# 2. Si Docker indisponible, passer directement √† la Phase 2
```

### **Phase 2 : Migration Dokploy**

#### **√âtape 1 : API (Critique)**
1. **Dans Dokploy Dashboard** :
   - Aller dans le projet API
   - Build Settings ‚Üí Advanced
   - Modifier `Dockerfile Path` : `apps/api/Dockerfile.debian`
   - Context reste : `.` (racine)

2. **D√©ployer et tester** :
   - D√©clencher un nouveau build
   - Surveiller les logs de d√©marrage
   - V√©rifier que Prisma s'initialise sans erreur

#### **√âtape 2 : Web et Admin**
R√©p√©ter pour `apps/web/Dockerfile.debian` et `apps/admin/Dockerfile.debian`

### **Phase 3 : Consolidation (Apr√®s validation)**

Une fois que tout fonctionne :
```bash
# Renommer les fichiers Debian comme principaux
mv apps/api/Dockerfile apps/api/Dockerfile.alpine
mv apps/api/Dockerfile.debian apps/api/Dockerfile

mv apps/web/Dockerfile apps/web/Dockerfile.alpine  
mv apps/web/Dockerfile.debian apps/web/Dockerfile

mv apps/admin/Dockerfile apps/admin/Dockerfile.alpine
mv apps/admin/Dockerfile.debian apps/admin/Dockerfile
```

## üîç **Probl√®mes r√©solus par la migration**

### **Avant (Alpine) - Probl√®mes fr√©quents**
```
‚ùå Error: EACCES: permission denied, mkdir 'logs'
‚ùå Error [ERR_REQUIRE_ESM]: require() of ES Module .../pdf.mjs
‚ùå OpenSSL configuration errors
‚ùå Prisma Engine binary incompatibility
‚ùå bcrypt/canvas native dependency issues
```

### **Apr√®s (Debian) - Solutions**
```
‚úÖ Permissions: glibc + apt package manager
‚úÖ ES Modules: Compatibilit√© native  
‚úÖ OpenSSL: Configuration automatique
‚úÖ Prisma: Binaires pr√©-compil√©s compatibles
‚úÖ Native deps: Support complet
```

## üìä **Impact attendu**

### **Taille des images**
| Application | Alpine | Debian | Delta |
|-------------|--------|--------|-------|
| API | ~80MB | ~150MB | +70MB |
| Web | ~70MB | ~130MB | +60MB |
| Admin | ~70MB | ~130MB | +60MB |

### **Temps de build**
- **Premier build** : +30% (installation apt)
- **Builds suivants** : Identique (cache Docker)

### **Stabilit√©**
- **R√©duction crashes** : 90%+ moins d'erreurs Prisma
- **Simplicit√© maintenance** : Suppression des workarounds
- **Debug facilit√©** : Plus d'outils syst√®me disponibles

## üö® **Points d'attention**

### **Surveillance post-migration**
1. **M√©triques Dokploy** :
   - CPU/RAM usage (peut l√©g√®rement augmenter)
   - Temps de d√©marrage
   - Taille de stockage

2. **Logs application** :
   - Pas d'erreurs Prisma/OpenSSL
   - Initialisation correcte des services
   - Performance des requ√™tes DB

3. **Tests fonctionnels** :
   - Upload de fichiers (pdf-parse)
   - Authentification (Better Auth + Prisma)
   - Chat avec AI models

## üõ†Ô∏è **Rollback plan**

Si probl√®mes avec Debian :
```bash
# Dans Dokploy
Dockerfile Path: apps/api/Dockerfile  # (revenir √† Alpine)
```

Ou localement :
```bash
# Restaurer Alpine comme principal
mv apps/api/Dockerfile.alpine apps/api/Dockerfile
```

## ‚úÖ **Checklist de migration**

### **Pre-migration**
- [ ] Sauvegarder configuration Dokploy actuelle
- [ ] Noter les versions actuelles qui fonctionnent
- [ ] Pr√©parer les Dockerfiles Debian

### **Migration**
- [ ] Modifier Dockerfile path dans Dokploy (API)
- [ ] D√©clencher build et surveiller logs
- [ ] Tester fonctionnalit√©s critiques
- [ ] R√©p√©ter pour Web et Admin

### **Post-migration**
- [ ] Surveiller m√©triques 24h
- [ ] Valider tous les endpoints API
- [ ] Confirmer stabilit√© uploads/auth
- [ ] Nettoyer anciens Dockerfiles Alpine

## üéØ **Recommandation finale**

**Migrer vers Debian** car :

1. **R√©solution d√©finitive** des probl√®mes Prisma/native
2. **Simplification** drastique de la configuration
3. **Am√©lioration** de la stabilit√© production
4. **Co√ªt acceptable** : +190MB total pour 3 applications

Le gain en stabilit√© et facilit√© de maintenance justifie largement l'augmentation de taille des images.

**Prochaine √©tape** : Commencer par l'API (plus critique) et valider le fonctionnement avant de migrer Web/Admin. üöÄ