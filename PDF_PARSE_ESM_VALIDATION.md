# PDF Parse ESM Fix - Validation Guide

## üéØ **Solution appliqu√©e**

### **Dual Package Override Strategy**
```json
{
  "pnpm": {
    "overrides": {
      "pdfjs-dist": "4.7.76",
      "pdf-parse": "1.1.1"
    }
  }
}
```

## ‚úÖ **Validation en local**

### **1. V√©rifier les versions install√©es**
```bash
# V√©rifier pdf-parse version
grep -A 5 "pdf-parse@1.1.1" pnpm-lock.yaml

# V√©rifier pdfjs-dist version  
grep -A 5 "pdfjs-dist@4.7.76" pnpm-lock.yaml

# Voir les overrides appliqu√©s
grep -A 3 "overrides:" pnpm-lock.yaml
```

**R√©sultat attendu** :
```yaml
overrides:
  pdfjs-dist: 4.7.76
  pdf-parse: 1.1.1
```

### **2. V√©rifier la compatibilit√© CommonJS**
```bash
# pdf-parse@1.1.1 utilise require(), pas import
grep -n "require\|import" "node_modules/.pnpm/pdf-parse@1.1.1/node_modules/pdf-parse/lib/pdf-parse.js"

# Doit montrer:
# 63:    PDFJS = PDFJS ? PDFJS : require(`./pdf.js/${options.version}/build/pdf.js`);
```

### **3. Test de build local**
```bash
# Build r√©ussi
pnpm --filter=@whalli/api build
```

**‚úÖ Status** : Tous les tests locaux r√©ussissent

## üê≥ **Validation Docker**

### **1. Test des builds Docker**
```bash
# Build API
docker build -f apps/api/Dockerfile . -t whalli-api-test

# Build Web  
docker build -f apps/web/Dockerfile . -t whalli-web-test

# Build Admin
docker build -f apps/admin/Dockerfile . -t whalli-admin-test
```

### **2. Test de d√©marrage avec PDF**
```bash
# D√©marrer le container API
docker run -d --name api-test \
  -e DATABASE_URL="postgresql://test" \
  -e REDIS_URL="redis://test" \
  whalli-api-test

# V√©rifier les logs (pas d'erreur ERR_REQUIRE_ESM)
docker logs api-test

# Nettoyer
docker rm -f api-test
```

## üöÄ **Validation Dokploy**

### **1. Red√©ploiement**
1. **Code pouss√©** : Commit `9da9f6a` contient la solution
2. **D√©ployer sur Dokploy** : Pull des derniers changements
3. **Observer les logs** : Plus d'erreur ERR_REQUIRE_ESM

### **2. Logs √† surveiller**

**‚ùå Avant (erreur)** :
```
Error [ERR_REQUIRE_ESM]: require() of ES Module 
/app/node_modules/.pnpm/pdfjs-dist@4.7.76/node_modules/pdfjs-dist/legacy/build/pdf.mjs not supported
```

**‚úÖ Apr√®s (succ√®s)** :
```
[Nest] Application successfully started
[Nest] FilesService initialized
[Nest] PDF extraction available
```

### **3. Test fonctionnel**

**Test d'upload PDF** :
```bash
# Via API REST
curl -X POST http://your-domain/api/files/upload \
  -F "file=@test.pdf" \
  -H "Authorization: Bearer YOUR_TOKEN"

# R√©ponse attendue:
{
  "id": "...",
  "filename": "test.pdf",
  "metadata": {
    "extractedText": "Contenu du PDF..."
  }
}
```

## üìä **Comparaison versions**

| Package | Version probl√©matique | Version fixe | Raison |
|---------|---------------------|--------------|---------|
| pdfjs-dist | 5.4.149 (ESM-only) | 4.7.76 (CommonJS) | Compatibilit√© require() |
| pdf-parse | 2.2.9 (importe ESM) | 1.1.1 (pure CommonJS) | Pas d'import ES Module |

## üîß **Architecture de la solution**

```
pdf-parse@1.1.1 (CommonJS)
    ‚Üì require()
pdfjs-dist@4.7.76/legacy/build/pdf.js (CommonJS)
    ‚Üì Compatible
Node.js require() system ‚úÖ
```

**vs. Probl√®me initial** :
```
pdf-parse@2.2.9 (CommonJS)
    ‚Üì require()
pdfjs-dist@5.x/legacy/build/pdf.mjs (ES Module)
    ‚Üì ‚ùå ERR_REQUIRE_ESM
Node.js require() system ‚ùå
```

## ‚úÖ **Checklist de validation**

- [x] pnpm-lock.yaml contient les overrides
- [x] pdf-parse@1.1.1 install√©
- [x] pdfjs-dist@4.7.76 install√©  
- [x] Build local r√©ussit
- [x] Client Prisma g√©n√©r√©
- [x] Commit et push effectu√©s
- [ ] Build Docker r√©ussi (√† tester en production)
- [ ] D√©ploiement Dokploy sans erreur
- [ ] Test fonctionnel PDF extraction
- [ ] Monitoring logs production

## üéâ **R√©sultat attendu**

L'erreur `ERR_REQUIRE_ESM` devrait √™tre compl√®tement r√©solue avec cette approche dual-downgrade. Les deux packages utilisent maintenant CommonJS de bout en bout.

**Commit de la solution** : `9da9f6a` - fix(pdf-parse): downgrade to pdf-parse@1.1.1 for ESM compatibility