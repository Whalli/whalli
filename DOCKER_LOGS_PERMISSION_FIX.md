# Docker Logs Permission Fix - EACCES mkdir 'logs'

## üö® **Erreur rencontr√©e**

```
Error: EACCES: permission denied, mkdir 'logs'
    at Object.mkdirSync (node:fs:1391:3)
    at File._createLogDirIfNotExist (/app/node_modules/.pnpm/winston@3.18.3/node_modules/winston/lib/winston/transports/file.js:759:10)
```

## üîç **Diagnostic**

Cette erreur se produit parce que :
1. Winston essaie de cr√©er un dossier `logs` dans `/app`
2. L'utilisateur `nestjs` du conteneur n'a pas les permissions d'√©criture
3. Le dossier n'existe pas et ne peut pas √™tre cr√©√©

## ‚úÖ **Solutions impl√©ment√©es**

### **Solution 1 : Dockerfile - Permissions et dossier logs**

**Changements dans `apps/api/Dockerfile`** :
```dockerfile
# Create logs directory with proper permissions
RUN mkdir -p /app/logs && chown -R nestjs:nestjs /app/logs

# Copy built application
COPY --from=builder /app/apps/api/dist ./apps/api/dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/apps/api/package.json ./apps/api/
COPY --from=builder /app/package.json ./

# Set ownership of application files
RUN chown -R nestjs:nestjs /app

USER nestjs
```

### **Solution 2 : Configuration Winston intelligente**

**Changements dans `logger.config.ts`** :
```typescript
// Determine logs directory based on environment
const isProduction = process.env.NODE_ENV === 'production';
const logsDir = isProduction ? '/tmp/logs' : (process.env.LOGS_DIR || 'logs');

// Add file transports with error handling
try {
  transports.push(
    new winston.transports.File({
      filename: `${logsDir}/error.log`,
      level: 'error',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json(),
      ),
    }),
  );

  transports.push(
    new winston.transports.File({
      filename: `${logsDir}/combined.log`,
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json(),
      ),
    }),
  );
} catch (error) {
  // Fallback to console only if file transports fail
  console.warn('Failed to initialize file transports, using console only:', 
    error instanceof Error ? error.message : String(error));
}
```

## üîß **Strat√©gie multi-environnement**

### **D√©veloppement local**
- **Logs directory** : `./logs` (dossier local)
- **File transports** : Activ√©s (error.log + combined.log)
- **Console transport** : Activ√©

### **Production Docker**
- **Logs directory** : `/tmp/logs` (syst√®me de fichiers temporaire)
- **File transports** : Activ√©s avec fallback
- **Console transport** : Activ√© (principal pour Docker logs)

### **Conteneur avec contraintes**
- **File transports** : D√©sactiv√©s automatiquement si erreur
- **Console transport** : Seul transport actif
- **Pas d'erreur fatale** : Application d√©marre quand m√™me

## üìä **Impact de la correction**

### **Avant (‚ùå Erreur)**
```
Error: EACCES: permission denied, mkdir 'logs'
Application crash ‚ùå
```

### **Apr√®s (‚úÖ Succ√®s)**
```
[2025-10-12T00:30:15.123Z] INFO: Application starting...
[2025-10-12T00:30:15.124Z] INFO: Winston logger initialized
[2025-10-12T00:30:15.125Z] INFO: File transports: /tmp/logs
Application start ‚úÖ
```

### **Fallback (‚ö†Ô∏è D√©grad√© mais fonctionnel)**
```
WARN: Failed to initialize file transports, using console only: EACCES
[2025-10-12T00:30:15.123Z] INFO: Application starting...
Application start ‚úÖ (console logs only)
```

## üê≥ **Variables d'environnement Docker**

### **Optionnelles pour personnalisation**
```yaml
# docker-compose.yml
services:
  api:
    environment:
      - NODE_ENV=production
      - LOGS_DIR=/tmp/logs        # Dossier de logs personnalis√©
      # ou pour d√©sactiver compl√®tement les logs fichier
      - DISABLE_FILE_LOGS=true
```

### **Dockerfile - Volume pour persistance (optionnel)**
```dockerfile
# Si vous voulez persister les logs
VOLUME ["/app/logs"]
```

## üöÄ **Validation**

### **Test local**
```bash
# Build et d√©marrage
pnpm --filter=@whalli/api build
pnpm --filter=@whalli/api start

# V√©rifier les logs
ls -la logs/
# Doit contenir: error.log et combined.log
```

### **Test Docker**
```bash
# Build Docker
docker build -f apps/api/Dockerfile . -t whalli-api-test

# D√©marrage avec logs
docker run --rm whalli-api-test

# V√©rifier pas d'erreur EACCES
```

### **Test production**
```bash
# Apr√®s d√©ploiement Dokploy, v√©rifier les logs
docker logs <container-id>

# Rechercher les messages Winston
# Pas d'erreur "permission denied"
```

## üìã **Checklist de r√©solution**

- [x] Dockerfile modifi√© (dossier logs + permissions)
- [x] Configuration Winston adaptative
- [x] Gestion d'erreur TypeScript corrig√©e
- [x] Build local r√©ussi
- [ ] Test Docker build
- [ ] D√©ploiement production
- [ ] Validation logs en production

## üéØ **R√©sultat attendu**

L'application devrait d√©marrer sans erreur `EACCES` avec :
1. **Logs fichier** : Fonctionnels en d√©veloppement et production (si permissions OK)
2. **Logs console** : Toujours disponibles (principal pour Docker)
3. **Fallback gracieux** : Application d√©marre m√™me si logs fichier √©chouent

**Priorit√©** : Console logs + Graceful degradation = Application robuste üõ°Ô∏è