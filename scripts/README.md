# GitHub Secrets Setup Scripts

Ce dossier contient plusieurs scripts pour configurer automatiquement les secrets GitHub Actions n√©cessaires au d√©ploiement de Whalli.

## üìã Scripts Disponibles

### 1. `auto-setup-secrets.sh` ‚ö° (Recommand√©)
**Script automatique rapide** - Cr√©e 18/21 secrets automatiquement depuis `.env.production.example`

```bash
./scripts/auto-setup-secrets.sh
```

**Avantages**:
- ‚úÖ Aucune interaction requise
- ‚úÖ Utilise les valeurs de `.env.production.example`
- ‚úÖ Tr√®s rapide (~5 secondes)
- ‚úÖ G√©n√®re automatiquement MINIO_ACCESS_KEY et MINIO_SECRET_KEY

**Secrets cr√©√©s** (18):
- DATABASE_URL, REDIS_PASSWORD, REDIS_URL
- JWT_SECRET, BETTER_AUTH_SECRET
- STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
- OPENAI_API_KEY, ANTHROPIC_API_KEY, XAI_API_KEY
- MINIO_ROOT_USER, MINIO_ROOT_PASSWORD, MINIO_ACCESS_KEY, MINIO_SECRET_KEY
- GRAFANA_ADMIN_PASSWORD
- DOMAIN, ACME_EMAIL

**Secrets manquants** (3):
- SSH_PRIVATE_KEY, SERVER_HOST, SERVER_USER

---

### 2. `add-server-secrets.sh` üîê
**Script interactif** - Ajoute les 3 secrets serveur manquants

```bash
./scripts/add-server-secrets.sh
```

**Fonctionnalit√©s**:
- ‚úÖ Guide interactif √©tape par √©tape
- ‚úÖ G√©n√©ration automatique de cl√© SSH (option 1)
- ‚úÖ Support de cl√© SSH existante (option 2)
- ‚úÖ Affichage de la cl√© publique √† ajouter au serveur
- ‚úÖ Instructions `ssh-copy-id` automatiques

**Secrets ajout√©s**:
1. **SERVER_HOST**: IP ou hostname du serveur de production
2. **SERVER_USER**: Nom d'utilisateur SSH (ubuntu, root, deploy, etc.)
3. **SSH_PRIVATE_KEY**: Cl√© priv√©e SSH pour le d√©ploiement

---

### 3. `setup-github-secrets.sh` üìù (Complet)
**Script interactif complet** - Configuration manuelle de tous les secrets

```bash
./scripts/setup-github-secrets.sh
```

**Avantages**:
- ‚úÖ Configuration 100% personnalis√©e
- ‚úÖ G√©n√®re automatiquement les secrets al√©atoires
- ‚úÖ Sauvegarde les secrets g√©n√©r√©s dans `/tmp/`
- ‚úÖ Guide d√©taill√© pour chaque secret

**Utilisation**:
- Pour une premi√®re configuration compl√®te
- Pour r√©g√©n√©rer tous les secrets
- Pour personnaliser chaque valeur

---

### 4. `quick-setup-secrets.sh` ‚ö°üìù (Hybride)
**Script hybride** - Automatique + interactif pour certains secrets

```bash
./scripts/quick-setup-secrets.sh
```

**Fonctionnement**:
- Lit automatiquement `.env.production.example`
- Demande uniquement les secrets serveur (SSH, HOST, USER)
- G√©n√®re automatiquement MINIO_ACCESS_KEY et MINIO_SECRET_KEY

---

## üöÄ Configuration Recommand√©e (2 √©tapes)

### √âtape 1: Secrets automatiques (18/21)
```bash
./scripts/auto-setup-secrets.sh
```
‚è±Ô∏è Dur√©e: ~5 secondes

### √âtape 2: Secrets serveur (3/21)
```bash
./scripts/add-server-secrets.sh
```
‚è±Ô∏è Dur√©e: ~2 minutes

**Total: 21/21 secrets configur√©s** ‚úÖ

---

## üìä Liste des 21 Secrets

### Server Access (3)
1. `SSH_PRIVATE_KEY` - Cl√© priv√©e SSH (multi-lignes)
2. `SERVER_HOST` - IP serveur (ex: `123.45.67.89`)
3. `SERVER_USER` - Username SSH (ex: `ubuntu`)

### Database (1)
4. `DATABASE_URL` - Neon Postgres connection string

### Application (4)
5. `REDIS_PASSWORD` - Redis password
6. `REDIS_URL` - Redis connection URL
7. `JWT_SECRET` - JWT signing secret
8. `BETTER_AUTH_SECRET` - Better Auth secret

### Stripe (3)
9. `STRIPE_SECRET_KEY` - Stripe API secret key
10. `STRIPE_WEBHOOK_SECRET` - Stripe webhook secret
11. `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key

### AI Providers (3)
12. `OPENAI_API_KEY` - OpenAI API key
13. `ANTHROPIC_API_KEY` - Anthropic/Claude API key
14. `XAI_API_KEY` - xAI/Grok API key

### MinIO (4)
15. `MINIO_ROOT_USER` - MinIO admin username
16. `MINIO_ROOT_PASSWORD` - MinIO admin password
17. `MINIO_ACCESS_KEY` - MinIO S3 access key (API)
18. `MINIO_SECRET_KEY` - MinIO S3 secret key (API)

### Monitoring (1)
19. `GRAFANA_ADMIN_PASSWORD` - Grafana admin password

### Domain (2)
20. `DOMAIN` - Production domain (ex: `whalli.com`)
21. `ACME_EMAIL` - Email pour Let's Encrypt SSL

---

## üîß Pr√©requis

### GitHub CLI
```bash
# Installation
# Ubuntu/Debian
sudo apt install gh

# macOS
brew install gh

# Arch Linux
sudo pacman -S github-cli

# Authentification
gh auth login
```

### OpenSSL
```bash
# V√©rifie si install√©
openssl version

# Ubuntu/Debian
sudo apt install openssl

# macOS (pr√©-install√©)
# Arch Linux
sudo pacman -S openssl
```

---

## üîç V√©rification

### V√©rifier les secrets GitHub
```bash
# Liste tous les secrets
gh secret list --repo Whalli/whalli

# V√©rifier un secret sp√©cifique (ne montre pas la valeur)
gh secret list --repo Whalli/whalli | grep DATABASE_URL
```

### Interface Web
https://github.com/Whalli/whalli/settings/secrets/actions

---

## üõ†Ô∏è Commandes Utiles

### G√©n√©rer un secret al√©atoire
```bash
openssl rand -base64 32
```

### G√©n√©rer une cl√© SSH
```bash
ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_deploy_key
```

### Copier la cl√© publique sur le serveur
```bash
ssh-copy-id -i ~/.ssh/github_deploy_key.pub user@server
```

### Tester la connexion SSH
```bash
ssh -i ~/.ssh/github_deploy_key user@server
```

### Supprimer un secret
```bash
gh secret delete SECRET_NAME --repo Whalli/whalli
```

### Mettre √† jour un secret
```bash
echo "new_value" | gh secret set SECRET_NAME --repo Whalli/whalli
```

---

## üîê S√©curit√©

### Bonnes Pratiques
1. ‚úÖ Ne **jamais** commit les secrets dans Git
2. ‚úÖ Utiliser des secrets diff√©rents pour staging/production
3. ‚úÖ R√©g√©n√©rer les secrets tous les 90 jours
4. ‚úÖ Utiliser une cl√© SSH d√©di√©e pour le d√©ploiement
5. ‚úÖ Activer 2FA sur GitHub et tous les providers (Stripe, OpenAI, etc.)
6. ‚úÖ Limiter les permissions de l'utilisateur SSH de d√©ploiement
7. ‚úÖ Supprimer les sauvegardes de secrets de `/tmp/` apr√®s v√©rification

### Fichiers √† ne JAMAIS commit
- `.env`
- `.env.production`
- `*.pem`, `*.key` (cl√©s priv√©es)
- `/tmp/whalli-secrets-backup-*.txt`

---

## ‚ùì D√©pannage

### "gh: command not found"
```bash
# Installer GitHub CLI
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
sudo apt update
sudo apt install gh
```

### "not authenticated with GitHub CLI"
```bash
gh auth login
# Suivre les instructions interactives
```

### "secret already exists"
Les secrets sont simplement √©cras√©s, pas d'erreur.

### "permission denied"
V√©rifier que vous avez les droits admin sur le repository Whalli/whalli.

---

## üìö Documentation Compl√®te

- [GITHUB_SECRETS_CHECKLIST.md](../GITHUB_SECRETS_CHECKLIST.md) - Liste de v√©rification compl√®te
- [GITHUB_ACTIONS_DEPLOYMENT.md](../GITHUB_ACTIONS_DEPLOYMENT.md) - Guide d√©ploiement GitHub Actions
- [ENVIRONMENT_VARIABLES_GUIDE.md](../ENVIRONMENT_VARIABLES_GUIDE.md) - Guide complet des variables d'environnement
- [.env.production.example](../.env.production.example) - Template de configuration

---

## üìù Exemple d'Utilisation

```bash
# 1. Cloner le repository
git clone https://github.com/Whalli/whalli.git
cd whalli

# 2. Authentification GitHub CLI
gh auth login

# 3. Configuration automatique (18 secrets)
./scripts/auto-setup-secrets.sh

# 4. Configuration serveur (3 secrets)
./scripts/add-server-secrets.sh
# ‚Üí Entrer IP serveur: 123.45.67.89
# ‚Üí Entrer username: ubuntu
# ‚Üí Choisir option 1 (g√©n√©rer nouvelle cl√©)
# ‚Üí Copier la cl√© publique sur le serveur

# 5. V√©rification
gh secret list --repo Whalli/whalli
# Devrait afficher 21 secrets

# 6. Tester le d√©ploiement
# Aller sur: https://github.com/Whalli/whalli/actions/workflows/deploy.yml
# ‚Üí Run workflow ‚Üí production ‚Üí Run
```

---

**Date**: 5 octobre 2025  
**Organisation**: Whalli  
**Repository**: https://github.com/Whalli/whalli  
**Maintainer**: √âquipe Whalli
