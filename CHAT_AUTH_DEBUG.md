# Chat Authentication Debug Guide - "Unauthorized" Error

## üö® **Erreur rencontr√©e**

```
Failed to send message: Error: Failed to start chat: Unauthorized
    at eval (useChat.ts:149:17)
    at async handleSendMessage (ChatUI.tsx:80:5)
```

## üîç **Diagnostic**

Cette erreur indique que l'API ne peut pas valider la session utilisateur lors de l'envoi de messages dans le chat.

### **Flux d'authentification**
1. **Frontend** : useChat.ts envoie POST `/api/chat/start` avec `credentials: 'include'`
2. **API** : AuthGuard extrait le token des cookies ou headers
3. **Validation** : AuthGuard valide la session avec Better-Auth via `AUTH_API_URL`
4. **√âchec** : La validation √©choue ‚Üí "Unauthorized"

## ‚úÖ **Solutions impl√©ment√©es**

### **Solution 1 : Configuration AUTH_API_URL**

**Probl√®me** : L'API ne sait pas o√π se trouve le service Better-Auth

**Correction** dans `docker-compose.yml` :
```yaml
api:
  environment:
    # Better-Auth integration (internal service communication)
    AUTH_API_URL: http://web:3000
```

**Correction** dans `docker-compose.prod.yml` :
```yaml
api:
  environment:
    # Better-Auth integration (internal service communication)
    AUTH_API_URL: http://web:4000
```

### **Solution 2 : Logs de debug √©tendus**

**Am√©lioration** de `auth.guard.ts` :
```typescript
console.log('[AuthGuard] AUTH_API_URL:', this.AUTH_API_URL);
console.log('[AuthGuard] Token found:', !!token);
console.log('[AuthGuard] Validating session at:', sessionUrl);
console.log('[AuthGuard] Session validation response status:', response.status);
```

## üîß **V√©rifications √† effectuer**

### **1. Configuration r√©seau Docker**

**V√©rifier les services** :
```bash
# Lister les conteneurs
docker ps

# V√©rifier la communication interne
docker exec whalli-api ping web
# Doit r√©ussir si les services sont sur le m√™me r√©seau
```

### **2. Variables d'environnement**

**Dans les logs API, rechercher** :
```
[AuthGuard] AUTH_API_URL: http://web:3000
```

**Si AUTH_API_URL = "http://localhost:3000"** ‚Üí ‚ùå Configuration manquante

### **3. Endpoint Better-Auth disponible**

**Tester depuis l'API** :
```bash
# Depuis le conteneur API
docker exec -it whalli-api curl http://web:3000/api/auth/session
```

**R√©ponse attendue** : Status 401 (car pas de token), mais pas "Connection refused"

### **4. Cookies de session pr√©sents**

**Dans les DevTools du navigateur** :
- **Application ‚Üí Cookies** 
- Rechercher : `better-auth.session_token`
- V√©rifier : Domain correct, pas expir√©

## üìä **Sc√©narios de debug**

### **Sc√©nario 1 : AUTH_API_URL incorrect**
```
[AuthGuard] AUTH_API_URL: http://localhost:3000
[AuthGuard] Session validation exception: fetch failed
```
**Solution** : Corriger l'URL vers le service web interne

### **Sc√©nario 2 : Pas de token**
```
[AuthGuard] Token found: false
[AuthGuard] No token found in request
```
**Solution** : V√©rifier l'authentification c√¥t√© frontend

### **Sc√©nario 3 : Service web inaccessible**
```
[AuthGuard] AUTH_API_URL: http://web:3000
[AuthGuard] Session validation exception: Connection refused
```
**Solution** : V√©rifier que le service web est d√©marr√©

### **Sc√©nario 4 : Session expir√©e**
```
[AuthGuard] Session validation response status: 401
[AuthGuard] Session validation error: Unauthorized
```
**Solution** : Relogin utilisateur requis

## üöÄ **Validation des corrections**

### **√âtape 1 : Red√©ploiement**
```bash
# Red√©ployer avec la nouvelle configuration
docker-compose up -d --build api

# Ou sur Dokploy : d√©clencher un nouveau build
```

### **√âtape 2 : V√©rifier les logs**
```bash
# Surveiller les logs API
docker logs -f whalli-api

# Rechercher les messages AuthGuard lors d'un test de chat
```

### **√âtape 3 : Test fonctionnel**
1. **Se connecter** sur l'application web
2. **Aller dans le chat** et envoyer un message
3. **V√©rifier les logs** : Pas d'erreur "Unauthorized"

### **Logs de succ√®s attendus** :
```
[AuthGuard] AUTH_API_URL: http://web:3000
[AuthGuard] Token found: true
[AuthGuard] Validating session at: http://web:3000/api/auth/session
[AuthGuard] Session validation response status: 200
[AuthGuard] Session data received: true
[AuthGuard] Authentication successful for user: user_xyz
```

## üìã **Checklist de r√©solution**

- [x] AUTH_API_URL ajout√© aux docker-compose
- [x] Logs de debug ajout√©s √† AuthGuard
- [x] Validation TypeScript corrig√©e
- [ ] Configuration d√©ploy√©e en production
- [ ] Test de communication inter-services
- [ ] Validation du chat fonctionnel

## üéØ **Causes les plus probables**

1. **ü•á AUTH_API_URL manquant** (90% des cas)
   - L'API ne peut pas joindre le service Better-Auth
   
2. **ü•à Service web non d√©marr√©** (5% des cas)
   - Docker compose pas compl√®tement up
   
3. **ü•â Session expir√©e** (5% des cas)
   - Utilisateur doit se reconnecter

## üîÑ **Prochaines √©tapes**

1. **D√©ployer** les corrections de configuration
2. **Tester** l'authentification avec les logs
3. **Nettoyer** les logs de debug une fois le probl√®me r√©solu

**R√©sultat attendu** : Le chat devrait fonctionner sans erreur "Unauthorized" ! üéâ