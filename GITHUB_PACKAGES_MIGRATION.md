# Migration vers l'Organisation Whalli - GitHub Actions

Documentation des modifications apport√©es aux workflows GitHub Actions pour utiliser le registry de l'organisation Whalli.

## üì¶ Modifications Effectu√©es

### 1. Workflow CI/CD (`.github/workflows/ci-cd.yml`)

#### **Avant** :
```yaml
username: ${{ github.actor }}  # Utilisateur personnel
images: ghcr.io/${{ github.repository }}/${{ matrix.app }}  # ghcr.io/GeekMonstar/whalli/web
```

#### **Apr√®s** :
```yaml
username: ${{ github.repository_owner }}  # Propri√©taire du repo (organisation)
images: ghcr.io/whalli/${{ matrix.app }}  # ghcr.io/whalli/web
```

### 2. Chemins des Images Docker

Les images Docker sont maintenant stock√©es dans le registry de l'organisation :

| Service | Ancien chemin | Nouveau chemin |
|---------|--------------|----------------|
| Web | `ghcr.io/geekmonstar/whalli/web` | `ghcr.io/whalli/web` |
| API | `ghcr.io/geekmonstar/whalli/api` | `ghcr.io/whalli/api` |
| Admin | `ghcr.io/geekmonstar/whalli/admin` | `ghcr.io/whalli/admin` |

### 3. Tags des Images

Tags automatiques ajout√©s :
- `type=ref,event=branch` - Nom de la branche (ex: `main`)
- `type=ref,event=pr` - Num√©ro de PR (ex: `pr-123`)
- `type=sha` - Hash du commit (ex: `sha-abc123`)
- `type=semver,pattern={{version}}` - Version s√©mantique (ex: `1.2.3`)
- `type=semver,pattern={{major}}.{{minor}}` - Version majeure.mineure (ex: `1.2`)

## üîê Permissions Requises

### GitHub Packages

Pour que les workflows fonctionnent, le `GITHUB_TOKEN` doit avoir les permissions suivantes :

```yaml
permissions:
  contents: read
  packages: write
```

Ces permissions sont automatiquement accord√©es par GitHub Actions dans le contexte de l'organisation.

### Organisation Whalli

L'organisation doit avoir :
- ‚úÖ GitHub Packages activ√©
- ‚úÖ Acc√®s public ou priv√© aux packages configur√©
- ‚úÖ Membres avec droits d'√©criture sur le repository

## üìä V√©rification

### V√©rifier les Images Build√©es

Apr√®s le prochain push sur `main`, les images seront visibles sur :

```
https://github.com/orgs/Whalli/packages?repo_name=whalli
```

Ou directement :
- https://github.com/Whalli/whalli/pkgs/container/web
- https://github.com/Whalli/whalli/pkgs/container/api
- https://github.com/Whalli/whalli/pkgs/container/admin

### Tester Localement

Pour tester les nouvelles images build√©es :

```bash
# Pull une image depuis le registry de l'organisation
docker pull ghcr.io/whalli/web:main
docker pull ghcr.io/whalli/api:main
docker pull ghcr.io/whalli/admin:main

# Run localement
docker run -p 3000:3000 ghcr.io/whalli/web:main
```

### Authentification pour Pull

Si les packages sont priv√©s, authentification requise :

```bash
# Cr√©er un Personal Access Token avec scope 'read:packages'
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# Ou utiliser GitHub CLI
gh auth token | docker login ghcr.io -u USERNAME --password-stdin
```

## üöÄ Workflow de D√©ploiement

### Option 1 : Build Local (Actuel)

Le workflow `deploy.yml` actuel build les images directement sur le serveur :

```bash
docker-compose -f docker-compose.prod.yml build --no-cache
```

**Avantages** :
- ‚úÖ Pas besoin d'authentification registry
- ‚úÖ Build adapt√© √† l'architecture du serveur

**Inconv√©nients** :
- ‚ö†Ô∏è Build plus lent (pas de cache distribu√©)
- ‚ö†Ô∏è Charge CPU √©lev√©e sur le serveur
- ‚ö†Ô∏è Temps de d√©ploiement plus long

### Option 2 : Pull depuis Registry (Recommand√©)

Modifier `docker-compose.prod.yml` pour utiliser les images pr√©-build√©es :

```yaml
services:
  web:
    image: ghcr.io/whalli/web:${IMAGE_TAG:-main}
    # Plus besoin de 'build:'
    
  api:
    image: ghcr.io/whalli/api:${IMAGE_TAG:-main}
    
  admin:
    image: ghcr.io/whalli/admin:${IMAGE_TAG:-main}
```

**Avantages** :
- ‚úÖ D√©ploiement ultra-rapide (juste pull + restart)
- ‚úÖ Images d√©j√† test√©es en CI
- ‚úÖ Pas de build sur le serveur production
- ‚úÖ Rollback instantan√© (juste changer le tag)

**Inconv√©nients** :
- ‚ö†Ô∏è N√©cessite authentification registry sur serveur

## üîÑ Migration vers Pull depuis Registry

### √âtape 1 : Modifier docker-compose.prod.yml

```yaml
# Avant (build local)
services:
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile

# Apr√®s (pull depuis registry)
services:
  web:
    image: ghcr.io/whalli/web:${IMAGE_TAG:-main}
```

### √âtape 2 : Authentifier le Serveur

Sur le serveur de production :

```bash
# Cr√©er un GitHub PAT avec scope 'read:packages'
# https://github.com/settings/tokens/new

# Se connecter au registry
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# V√©rifier
docker pull ghcr.io/whalli/web:main
```

### √âtape 3 : Modifier le Workflow deploy.yml

```yaml
- name: Deploy to server
  run: |
    ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
      cd /opt/whalli
      git pull origin main
      
      # Plus besoin de build, juste pull
      docker-compose -f docker-compose.prod.yml pull
      docker-compose -f docker-compose.prod.yml up -d
    ENDSSH
```

### √âtape 4 : Variables d'Environnement

Ajouter dans le workflow ou `.env` :

```bash
IMAGE_TAG=main  # ou sha-abc123, ou v1.2.3
```

## üìà Avantages de la Migration

### Performance
- ‚ö° **Build Time** : ~5 min ‚Üí ~30 sec (pull uniquement)
- ‚ö° **Deployment Time** : ~10 min ‚Üí ~2 min
- ‚ö° **Rollback Time** : ~10 min ‚Üí ~30 sec

### Fiabilit√©
- ‚úÖ Images test√©es en CI avant d√©ploiement
- ‚úÖ M√™me image en staging et production
- ‚úÖ Rollback instantan√© vers version pr√©c√©dente
- ‚úÖ Pas de "build failed" en production

### Co√ªts
- üí∞ Moins de CPU utilis√© sur serveur production
- üí∞ D√©ploiements plus rapides = moins de downtime
- üí∞ Registry GitHub gratuit (500MB public, 2GB priv√©)

## üîç Monitoring

### Surveiller les Builds

Dashboard GitHub Actions :
```
https://github.com/Whalli/whalli/actions
```

### Surveiller les Packages

Registry de l'organisation :
```
https://github.com/orgs/Whalli/packages
```

Metrics disponibles :
- Nombre de pulls
- Taille des images
- Versions disponibles
- Vuln√©rabilit√©s d√©tect√©es

### Nettoyer les Anciennes Images

GitHub conserve toutes les versions. Pour nettoyer :

```bash
# Via GitHub CLI
gh api \
  --method DELETE \
  -H "Accept: application/vnd.github+json" \
  /orgs/Whalli/packages/container/web/versions/OLD_VERSION_ID
```

Ou configurer une politique de r√©tention :
```yaml
# .github/workflows/cleanup-packages.yml
- name: Delete old package versions
  uses: actions/delete-package-versions@v4
  with:
    package-name: 'web'
    package-type: 'container'
    min-versions-to-keep: 10
    delete-only-untagged-versions: true
```

## üéØ Next Steps

1. ‚úÖ **Effectu√©** : Modifier ci-cd.yml pour utiliser registry organisation
2. ‚è≥ **√Ä faire** : Tester le build avec un push sur main
3. ‚è≥ **√Ä faire** : V√©rifier les images dans le registry
4. ‚è≥ **Optionnel** : Migrer vers pull depuis registry (plus rapide)
5. ‚è≥ **Optionnel** : Configurer cleanup automatique des vieilles images

## üìö Documentation Officielle

- [GitHub Packages Documentation](https://docs.github.com/en/packages)
- [GitHub Container Registry](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
- [Docker Build Push Action](https://github.com/docker/build-push-action)
- [Docker Metadata Action](https://github.com/docker/metadata-action)

---

**Date de migration** : 5 octobre 2025  
**Organisation** : Whalli  
**Repository** : whalli  
**Registry** : ghcr.io/whalli  
**Status** : ‚úÖ Configur√© et pr√™t
